# Backend FastAPI del visual editor

Il backend in `visual-editor/backend/app` espone gli endpoint di import, validazione ed esecuzione mock descritti in `main.py`. I payload sono validati con i modelli Pydantic definiti in `models.py`, garantendo le stesse regole applicate dal frontend TypeScript (`visual-editor/src/workflow-format.ts`).【F:visual-editor/backend/app/main.py†L9-L91】【F:visual-editor/backend/app/models.py†L30-L258】【F:visual-editor/src/workflow-format.ts†L18-L148】 

## Mapping nodi → componenti Python

| kind | Convenzione `data.component` | Tipo di risultato previsto | Serializzazione consigliata |
| --- | --- | --- | --- |
| `input` | `datapizza.modules.parsers.<provider>.<Classe>` oppure `datapizza.modules.treebuilder.<Classe>`【F:datapizza-ai-core/datapizza/modules/parsers/__init__.py†L1-L6】【F:datapizza-ai-core/datapizza/modules/treebuilder/__init__.py†L1-L4】 | Oggetti `Node` che rappresentano alberi documentali.【F:datapizza-ai-core/datapizza/type/type.py†L353-L424】 | Convertire ricorsivamente in dizionari con `node.node_type.value`, `node.metadata` e `children`, quindi restituire nel campo `outputs` del `WorkflowExecutionResult` (es. `outputs.nodeOutputs[nodeId]`).【F:visual-editor/src/workflow-format.ts†L136-L148】 |
| `task` | `datapizza.modules.splitters.*`, `datapizza.modules.captioners.LLMCaptioner`, `datapizza.modules.metatagger.KeywordMetatagger`, `datapizza.modules.rerankers.*`, `datapizza.modules.prompt.*`, `datapizza.modules.rewriters.ToolRewriter`【F:datapizza-ai-core/datapizza/modules/splitters/__init__.py†L1-L11】【F:datapizza-ai-core/datapizza/modules/captioners/__init__.py†L1-L4】【F:datapizza-ai-core/datapizza/modules/metatagger/__init__.py†L1-L4】【F:datapizza-ai-modules/rerankers/cohere/datapizza/modules/rerankers/cohere/__init__.py†L1-L4】【F:datapizza-ai-modules/rerankers/together/datapizza/modules/rerankers/together/__init__.py†L1-L4】【F:datapizza-ai-core/datapizza/modules/prompt/__init__.py†L1-L4】【F:datapizza-ai-core/datapizza/modules/rewriters/__init__.py†L1-L4】 | Varia a seconda del modulo: liste di `Chunk`, `Node` aggiornati, stringhe, oggetti `Memory`.【F:datapizza-ai-core/datapizza/modules/splitters/text_splitter.py†L27-L61】【F:datapizza-ai-core/datapizza/modules/captioners/llm_captioner.py†L100-L164】【F:datapizza-ai-core/datapizza/modules/metatagger/keyword_metatagger.py†L38-L86】【F:datapizza-ai-modules/rerankers/cohere/datapizza/modules/rerankers/cohere/cohere_reranker.py†L66-L138】【F:datapizza-ai-core/datapizza/modules/prompt/prompt.py†L34-L96】【F:datapizza-ai-core/datapizza/modules/rewriters/tool_rewriter.py†L38-L93】 | Serializzare `Chunk` come dict (`id`, `text`, `metadata`, `embeddings` se presenti), i `Node` come descritto per gli input, le stringhe direttamente e le `Memory` con `memory.to_dict()`.【F:datapizza-ai-core/datapizza/type/type.py†L467-L492】【F:datapizza-ai-core/datapizza/memory/memory.py†L45-L200】 Inserire i risultati nel campo `outputs` usando chiavi esplicite (es. `taskOutputs`). |
| `output` | `datapizza.pipeline.IngestionPipeline` per orchestrare componenti e `datapizza.vectorstores.<provider>.<Classe>` per la persistenza (es. `datapizza.vectorstores.qdrant.QdrantVectorstore`).【F:datapizza-ai-core/datapizza/pipeline/pipeline.py†L34-L200】【F:datapizza-ai-vectorstores/datapizza-ai-vectorstores-qdrant/datapizza/vectorstores/qdrant/qdrant_vectorstore.py†L19-L200】 | Operazioni di persistenza o recupero su collezioni di `Chunk`; le pipeline possono restituire `Chunk[]` se nessun vector store è configurato.【F:datapizza-ai-core/datapizza/pipeline/pipeline.py†L61-L134】 | Confermare l’esito in `outputs` (es. `{"collection": ..., "stored": n}`) e serializzare eventuali `Chunk` come sopra. Le risposte di ricerca possono essere inviate al frontend sotto `outputs.retrieval` mantenendo l’ordine fornito dal retriever.【F:datapizza-ai-core/datapizza/core/vectorstore/vectorstore.py†L25-L112】 |

### Componenti per nodi `input`

- **`datapizza.modules.parsers.text_parser.TextParser`**: suddivide un testo in documenti/paragrafi/frasi senza parametri obbligatori.【F:datapizza-ai-core/datapizza/modules/parsers/text_parser.py†L7-L93】 
- **`datapizza.modules.parsers.docling.DoclingParser`**: accetta PDF e opzionalmente `json_output_dir` per salvare l’estrazione intermedia.【F:datapizza-ai-modules/parsers/docling/datapizza/modules/parsers/docling/docling_parser.py†L17-L90】 
- **`datapizza.modules.parsers.azure.AzureParser`**: richiede `api_key`, `endpoint` e permette `result_type` personalizzato per i payload di Azure Document Intelligence.【F:datapizza-ai-modules/parsers/azure/datapizza/modules/parsers/azure/azure_parser.py†L17-L156】 
- **`datapizza.modules.treebuilder.LLMTreeBuilder`**: costruisce alberi semantici da testo grezzo usando un client LLM e supporta un `system_prompt` opzionale.【F:datapizza-ai-core/datapizza/modules/treebuilder/llm_treebuilder.py†L35-L147】 

### Componenti per nodi `task`

- **Splitter**: `TextSplitter`, `RecursiveSplitter`, `NodeSplitter`, `PDFImageSplitter` permettono di generare `Chunk` a partire da testo o alberi con parametri come `max_char`, `overlap`, `image_format` e `dpi` per i PDF.【F:datapizza-ai-core/datapizza/modules/splitters/text_splitter.py†L7-L63】【F:datapizza-ai-core/datapizza/modules/splitters/recursive_splitter.py†L7-L99】【F:datapizza-ai-core/datapizza/modules/splitters/node_splitter.py†L5-L54】【F:datapizza-ai-core/datapizza/modules/splitters/pdf_image_splitter.py†L12-L122】 
- **Captioner**: `LLMCaptioner` aggiunge descrizioni a nodi multimediali e accetta un client LLM più parametri di tuning (`max_workers`, prompt dedicati).【F:datapizza-ai-core/datapizza/modules/captioners/llm_captioner.py†L9-L200】 
- **Metatagger**: `KeywordMetatagger` arricchisce i chunk con parole chiave sfruttando un client LLM e parametri opzionali per prompt e nome del campo di output.【F:datapizza-ai-core/datapizza/modules/metatagger/keyword_metatagger.py†L11-L86】 
- **Reranker**: `CohereReranker` e `TogetherReranker` richiedono le rispettive credenziali/API e parametri `top_n`/`threshold` per filtrare i risultati.【F:datapizza-ai-modules/rerankers/cohere/datapizza/modules/rerankers/cohere/cohere_reranker.py†L5-L138】【F:datapizza-ai-modules/rerankers/together/datapizza/modules/rerankers/together/together_reranker.py†L5-L74】 
- **Prompt builder**: `ChatPromptTemplate` e `ImageRAGPrompt` generano `Memory` combinando prompt Jinja2, chunk recuperati e, nel caso image-RAG, estrazioni multimediali da PDF.【F:datapizza-ai-core/datapizza/modules/prompt/prompt.py†L18-L109】【F:datapizza-ai-core/datapizza/modules/prompt/image_rag.py†L9-L111】 
- **Rewriter**: `ToolRewriter` usa un client LLM con strumenti opzionali per trasformare query testuali, restituendo stringhe pronte per step successivi.【F:datapizza-ai-core/datapizza/modules/rewriters/tool_rewriter.py†L9-L105】 

### Componenti per nodi `output`

- **`datapizza.pipeline.IngestionPipeline`**: orchestration di moduli di parsing/elaborazione con possibilità di push automatico verso un vector store; restituisce i `Chunk` finali se nessun backend è collegato.【F:datapizza-ai-core/datapizza/pipeline/pipeline.py†L34-L134】 
- **`datapizza.vectorstores.qdrant.QdrantVectorstore`** (ed estensioni analoghe): implementa metodi `add/a_add`, `search/a_search`, `retrieve` e `remove` per gestire collezioni di chunk, producendo o consumando liste di `Chunk`.【F:datapizza-ai-vectorstores/datapizza-ai-vectorstores-qdrant/datapizza/vectorstores/qdrant/qdrant_vectorstore.py†L19-L200】 
- **`Vectorstore.as_retriever`**: consente di trasformare un vector store in componente da utilizzare come nodo `task`/`output` che restituisce chunk ordinati secondo la ricerca semantica.【F:datapizza-ai-core/datapizza/core/vectorstore/vectorstore.py†L25-L112】 

### Serializzazione dei risultati verso il frontend

Per mantenere omogeneo il contratto con il frontend:

1. Popolare `WorkflowExecutionResult.steps` con l’avanzamento del job e usare `outputs` per i dati prodotti da ogni nodo.【F:visual-editor/src/workflow-format.ts†L136-L148】 
2. Serializzare i `Chunk` come dizionari semplici (id, text, metadata, embeddings) e i `Node` come alberi JSON annidati; per `Memory` utilizzare `memory.to_dict()` o `memory.json_dumps()` a seconda delle esigenze dell’interfaccia.【F:datapizza-ai-core/datapizza/type/type.py†L467-L492】【F:datapizza-ai-core/datapizza/memory/memory.py†L45-L200】 
3. Restituire eventuali ID di collezione, conteggi o riferimenti ad artefatti (`s3://…`) in chiavi dedicate (`collection`, `stored`, `artifacts`) all’interno di `outputs` così da consentire al frontend di mapparli su pannelli di dettaglio.【F:visual-editor/backend/app/models.py†L244-L258】 

